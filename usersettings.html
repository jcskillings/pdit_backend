<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paidit | Bill Analysis</title>
    <link rel="stylesheet" href="css/usersettings.css" />
    <link rel="stylesheet" href="css/foundation.css" />
    <link rel="stylesheet" href="css/test.css" />
    <link rel="shortcut icon" href="img/icon/checkMark.png"/>
    <script type="text/javascript" src="js/users.js"></script>
    <script type="text/javascript" src="js/responsive-tables.js"></script>
    <script src="js/vendor/modernizr.js"></script>
  </head>
  <body onload="getUserInfo()">
    
      
  <div class="icon-bar five-up">
    <a class="item" href="home.html">
      <img src="img/icon/homeIconG.png" height="20" width="20"  >
      <label class="show-for-medium-up">Home</label>
    </a>
    <a class="item" href="analysis.html">
      <img src="img/icon/chartsIconG.png" height="20" width="20">
      <label class="show-for-medium-up">Bill Analysis</label>
    </a>
    <a class="item" href="billaccounts.html">
      <img src="img/icon/billIconG.png" height="20" width="20">
      <label class="show-for-medium-up">Bills</label>
    </a>
    <a class="item" href="notificationslog.html">
      <img src="img/icon/smsIconG.png" height="20" width="20">
      <label class="show-for-medium-up">Notification Log</label>
    </a>
    <a class="item" href="usersettings.html" id="settings">
      <img src="img/icon/gearIconG.png" height="20" width="20">
      <label class="show-for-medium-up" id="settingstext">Settings</label>
    </a>
  </div>
    
  <div class="container navigation" style = "width:100%; margin:2% 0% 0% 0%">
    <div class="left">
      <h2><b>Welcome to Settings!</b></h2>
      <table class="large-20 columns" id="userTable" name="userTable">
        <tr>
          <th>Username:</th>
          <td><input id="username" type="text" placeholder="username" name="username"/></td>
        </tr>
        <tr>
          <th>First Name:</th>
          <td><input id="firstname" type="text" placeholder="firstname" name="firstname" /></td>
        </tr>
        <tr>
          <th>Lase Name:</th>
          <td><input id="lastname" type="text" placeholder="lastname" name="lastname" /></td>
        </tr>
        <tr>
          <th>Password:</th>
          <td><input id="password" type="text" placeholder="password" name="password" /></td>
        </tr>
        <tr>
          <td></td>
          <td><button style="width:100%;" onClick="saveUser()" id="save">Save User</button></td>
        </tr>
      </table>
    </div>
    <div class="right">
      <ul class="button-group radius even-1 ">
        <button onClick="logout()" id="logout">Logout</button>
      </ul>
      <div class="small-12 large-12 columns">
        <h1><a href="#" data-reveal-id="verModal" class="button radius">Enter Verification Code</a>
        Notification Methods<a href="#" class='button radius' id='addNotif'>Add Notification Method</a></h1>
        <table id="userTable2" name="userTable2">
          <thead  id="billTableHeader">
            <tr>
              <th width="20%">Name</th>
              <th width="20%">Phone#/Email</th>
              <th width="10%">Type</th>
              <th width="10%">Carrier</th>
              <th width="10%"></th>
              <th width="30%"></th>
            </tr>
          </thead>
          <tbody id ="tbody"></tbody>
        </table>
        <a href="#" class="button radius" id="saveEdit">Save</a>
        <a href="#" class="button radius" id="cancelEdit">Cancel</a>        
        <a href="#" class="button radius" id="saveBtn">Save</a>
        <a href="#" class="button radius" id="cancelBtn">Cancel</a>
      </div>
    </div>
    <div class="clear"></div>
  </div>
    <hr />
    
    <!--  verification modal-->
    <div div id="verModal" class="reveal-modal tiny" data-reveal aria-labelledby="Verification" aria-hidden="true" role="dialog">
      <div class="row">
          <div class="large-6 large-centered columns">
            <a><img src="img/logoSm.png" /></a>
          </div>
        </div>
      <form id="verForm" data-abide name='verForm' onsubmit="return validateForm()" method="post">
        
        <div class="row">
          <div class="large-6 large-centered columns">
            <label></br>Enter 10-digit code below
              <input type="text" placeholder="12ab34cd56" id='verCode' name='verCode'/>
            </label>
          </div>
        </div>
        <div class="row">
          <div class="large-6 large-centered columns">
            <input href="#" type="submit" class="radius button" value="Submit Code"/>
          </div>
        </div>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
      </form>
    </div>     <!--  verification modal-->
    
    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    <script type = "text/javascript"> 
      $(document).foundation();
      
      var userName;
      var firstName;
      var lastName;
      var email;
      var phone;
      var password;
      var notifs;
      var numNotifs;
      
      function getUserInfo(){
        var currUser = JSON.parse(getCookie("currUser"));
        firstName = currUser.firstName;
        userName = currUser.userName;
        lastName = currUser.lastName;
        password = currUser.password;
        document.getElementById("username").value = userName;
        document.getElementById("firstname").value = firstName;
        document.getElementById("lastname").value = lastName;
        document.getElementById("password").value = password;
        notifs = JSON.parse(getCookie("NM"));
        numNotifs = notifs.methods.length;
        for  (var j=1; j < numNotifs+1; j++){
            putNotif(j);
          }
      }
      
      function putNotif(index){
        var table = document.getElementById("userTable2");
        var row = table.insertRow(index);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        var cell5 = row.insertCell(4);
        var cell6 = row.insertCell(5);
       
        cell1.innerHTML = notifs.methods[index-1].name;
        cell2.innerHTML = notifs.methods[index-1].destination;
        cell3.innerHTML = notifs.methods[index-1].type;
        cell4.innerHTML = notifs.methods[index-1].carrier;
        cell5.innerHTML = notifs.methods[index-1].verified;
        cell6.innerHTML = '<button onClick="editRow(this)" id="edit"+index>Edit</button> <button onClick="deleteRow(this)">Delete</button>';
      }
      
      function youCannot(){
        alert("You cannot edit/delete a notification method while currently editing one");
      }
      
      function editRow(o) {
        var p=o.parentNode.parentNode;
        p.parentNode.removeChild(p);
        putInEditField();
      }
      
      var newJson;
      var NM;
      var type;
      var name;
      var destination;
      var carrier;
      var verified;
      
      function putInEditField() {
        var j;
        var table = document.getElementById("userTable2");
        name = null;
        destination = null;
        carrier = null;
        type = null;
        verified = null;
        newJson = null;
        var find;
        
        for(j = 1; j < numNotifs; j++){
          var named = notifs.methods[j-1].name;
          var row = table.rows.item(j).cells[0].firstChild.data;
          if (named != row) {
            alert("entered");
            name = notifs.methods[j-1].name;
            destination = notifs.methods[j-1].destination;
            carrier = notifs.methods[j-1].carrier;
            type = notifs.methods[j-1].type;
            verified = notifs.methods[j-1].verified;
            NM = getCookie("NM");
            find = '{"type":"' +type+'","destination":"'+destination+'","carrier":"'+carrier+
              '","verified":"'+verified+'","name":"'+name;
            var tempCookie = NM.substring(0, NM.indexOf(find));
            var find2 = '{"type":"' +notifs.methods[j].type+'","destination":"'+
              notifs.methods[j].destination+'","carrier":"'+notifs.methods[j].carrier+
              '","verified":"'+notifs.methods[j].verified+'","name":"'+
              table.rows.item(j).cells[0].firstChild.data;
            newJson = NM.substring(NM.indexOf(find2), NM.length);
            newJson = tempCookie + newJson;
            break;
          }
        }
        if(newJson == null) { //editing last  & there is more than 1 bill
          alert("second");
          name = notifs.methods[(numNotifs-1)].name;
          destination = notifs.methods[(numNotifs-1)].destination;
          carrier = notifs.methods[(numNotifs-1)].carrier;
          type = notifs.methods[(numNotifs-1)].type;
          verified = notifs.methods[(numNotifs-1)].verified;
          NM = getCookie("NM");
          alert("NM is " +NM);
          if(numNotifs == 1) find = '{"type":"' +type+'","destination":"'+destination+'","carrier":"'+carrier+
              '","verified":"'+verified+'","name":"'+name;
          else find = ',{"type":"' +type+'","destination":"'+destination+'","carrier":"'+carrier+
              '","verified":"'+verified+'","name":"'+name;
          alert("find is " +find);
          newJson = NM.substring(0, NM.indexOf(find))+"]}";
          alert("NJ before is " + newJson);
        }
        $('#addNotif').css('visibility','hidden');
    
        $('#userTable2').find('tbody').append($('<tr id="createNotif">')
        .append($('<td><input type="text" placeholder="bill name" id="name" value = \''+name+'\' required /></td>'))
        .append($('<td>\''+destination+'\'</td>'))
        .append($('<td>\''+type+'\'</td>'))
        .append($('<td>\''+carrier+'\'</td>'))
        .append($('<td>\''+verified+'\'</td>'))
        );
        $('#saveEdit').css('visibility','visible');
        $('#cancelEdit').css('visibility','visible');
        var myTable = document.getElementById("userTable2");
        for(var i = 1; i < numNotifs+1; i++){
          myTable.rows[i].cells[5].innerHTML = '<button onClick="youCannot()">Edit</button><button onClick="youCannot()">Delete</button>';
        }
      }
      
      function deleteRow(o){
        if (confirm("Are you sure?  Deleting this Notification Method cannot be undone!") == true){
        var p=o.parentNode.parentNode;
        p.parentNode.removeChild(p);
        updateJson();
        }
      }
      
      function updateJson(){
        var j;
        var table = document.getElementById("userTable2");
        for(j = 1; j < numNotifs; j++){
          var name = notifs.methods[j-1].name;
          var destination = notifs.methods[j-1].destination;
          var carrier = notifs.methods[j-1].carrier;
          var type = notifs.methods[j-1].type;
          var verified = notifs.methods[j-1].verified;
          var total = '{"type":"' +type+'","destination":"'+destination+'","carrier":"'+carrier+
              '","verified":'+verified+',"name":"'+name;
          var row = '{"type":"' +type+'","destination":"'+
              destination+'","carrier":"'+carrier+
              '","verified":'+verified+',"name":"'+
              table.rows.item(j).cells[0].firstChild.data;
          if (total != row) {
            NM = getCookie("NM");
            var tempCookie = NM.substring(0, NM.indexOf(total));
            var tempCookie2 = NM.substring(NM.indexOf(row), NM.length);
            tempCookie2 = tempCookie + tempCookie2;
            var message = "You deleted a " + type + " Notification Method named " +
              name + " for " + destination;
            addNL(message);
            //alert("removed the " + j + "th method! named " + name +" row is " + table.rows.item(j).cells[0].firstChild.data);
            setCookie("NM", tempCookie2, 30);
            return;
          }
        }
        name = notifs.methods[j-1].name;
        destination = notifs.methods[j-1].destination;
        carrier = notifs.methods[j-1].carrier;
        type = notifs.methods[j-1].type;
        verified = notifs.methods[j-1].verified;
        NM = getCookie("NM");
        total = '{"type":"' +type+'","destination":"'+destination+'","carrier":"'+carrier+
              '","verified":'+verified+',"name":"'+name;
        tempCookie = NM.substring(0, NM.indexOf(total))+"]}";
        setCookie("NM", tempCookie, 30);
      }
      
      $('#addNotif').click(function(){
        $('#addNotif').css('visibility','hidden');
        //testGet2();
        
        $('#userTable2').find('tbody').append($('<tr id="createNotif">')
        .append($('<td><input type="text" placeholder="Notification name" id="name" required /></td>'))
        .append($('<td><input type="text" placeholder="destination address" id="destination"  /></td>'))
        .append($('<td><select style="width:100px;" id="typeDrop">'+
          '<option value="email" id="email">Email</option><option id="phone" value="phone">Phone#</option></select></td>'))
        .append($('<td><select style="width:100px;" id="carrierDrop"><option value="none" id="none">Select</option>'+
          '<option value="at&t" id="at&t">at&t</option><option id="sprint" value="sprint">Sprint</option>'+
          '<option value="t-mobile" id="t-mobile">T-Mobile</option><option id="verizon" value="verizon">Verizon</option>'+
          '<option value="virgin" id="virgin">Virgin</option><option value="boost" id="boost">Boost</option>'+
          '<option value="alltel" id="alltel">Alltel</option></select></td>'))
        .append($('<td>not verified</td>'))
        );
        $('#saveBtn').css('visibility','visible');
        $('#cancelBtn').css('visibility','visible');
      });
      
      $('table').on('click', '.delete', function(){
        $(this).closest('tr').remove();
      });
      
      $('#cancelBtn').click( function() {
          $('#createNotif').remove();
          $('#saveBtn').css('visibility','hidden');
          $('#cancelBtn').css('visibility','hidden');
          $('#addNotif').css('visibility','visible');
      });
      
      $('#cancelEdit').click( function() {
          $('#createNotif').remove();
          $('#saveEdit').css('visibility','hidden');
          $('#cancelEdit').css('visibility','hidden');
          $('#addNotif').css('visibility','visible');
          window.location.reload();
      });
      
      $('#saveEdit').click( function() {
        $('#saveEdit').click(null);
        var name1 = document.getElementById("name").value;
        var newNotif = new Method(type, destination, carrier, verified, name1);
        var stringy = JSON.stringify(newNotif);
        NM = newJson;
        alert("NJ is " + newJson);
        var tempBills = NM.substring(0, NM.length - 2);
        if (numNotifs == 1) NM = tempBills + stringy + "]}";
        else NM = tempBills + "," + stringy + "]}";
        alert("NM is " + NM);
        setCookie("NM",NM,30);
        $('#addNotif').css('visibility','visible');
        window.location.replace("usersettings.html");
      });
      
      $('#saveBtn').click( function() {
        $('#saveBtn').click(null);
        var name = document.getElementById("name").value;
        var carrier =  document.getElementById("carrierDrop").value;
        var type = document.getElementById("typeDrop").value;
        var destination = document.getElementById("destination").value;
        var newNotif = new Method(type, destination, carrier, "not verified", name);
        var stringy = JSON.stringify(newNotif);
        NM = (getCookie("NM"));
        var tempBills = NM.substring(0, NM.length - 2);
        if (numNotifs == 0) {
          NM = tempBills + stringy + "]}";
        }
        else{
          NM = tempBills + "," + stringy + "]}";
        }
        alert(NM);
        setCookie("NM",NM,30);
        $('#addNotif').css('visibility','visible');
        var message = "You added a new " + type + " Notification Method named " +
          name + " to be sent to " + destination;
        addNL(message);
        window.location.replace("usersettings.html");
      });
      
      function logout() {
        setCookie("currUser", "", 30);
        window.location.replace("splash.html");
        return;
      }
      
      function setCookie(cname,cvalue,exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname+"="+cvalue+"; "+expires;
      }

      function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) {
              return c.substring(name.length, c.length);
            }
          }
        return "";
      }
      
      function validateForm() {   
      var code = document.forms["verForm"]["verCode"].value;
        if (code == null || code == "") {
          alert("Verification Code must be filled out to submit");
          return false;
        } 
        else {
          if (code.length < 10 || code.length > 10){
            alert("Code must be of length 10!");
            return false;
          }
        }
      }
      
      // Bill object constructor
      function User(userName, email, firstName, lastName, phone,  password){
        this.userName = userName;
        this.email = email;
        this.firstName = firstName;
        this.lastName = lastName;
        this.phone = phone;
        this.password = password;
      }
      
      function Method(type, destination, carrier, verified, name) {
        this.type = type;
        this.destination = destination;
        this.carrier = carrier;
        this.verified = verified;
        this.name = name;
      }
      
      function Log(info, date, time) {
        this.info = info;
        this.date = date;
        this.time = time;
      }
      
      function addNL(message){
        var currDate = Date();
        var currTime = currDate.substring(16, 24);
        currDate = currDate.substring(4, 15);
        var newLog = new Log(message, currDate, currTime);
        var stringy = JSON.stringify(newLog);
        var NL = JSON.parse(getCookie("NL"));
        //alert(NL);
        var numLogs = NL.logs.length;
        //alert(numLogs);
        NL=getCookie("NL");
        var temp = NL.substring(0, NL.length - 2);
        if (numLogs == 0) {
          NL = temp + stringy + "]}";
        }
        else{
          NL = temp + "," + stringy + "]}";
        }
        setCookie("NL",NL,30);
      }
      
      
      function saveUser(){
        var obj = JSON.parse(getCookie("allUsers"));
        var numUsers = obj.users.length;
        var userIndex;
        var userName1 = document.getElementById("username").value;
        var named;
        for  (userIndex=0; userIndex < numUsers; userIndex++){
          named = obj.users[userIndex].userName;
          if(userName == named) break;
        }
        var firstName1 = document.getElementById("firstname").value;
        var lastName1 = document.getElementById("lastname").value;
        var password1 = document.getElementById("password").value;
        var newMessage = "";
        var numChanged = 0;
        
        if(userName == userName1 && firstName == firstName1 &&
          lastName==lastName1 && password==password1){
          alert("No changes were made/saved!");
          return;
        }
        else{
          if(userName != userName1) {
            for  (var i=0; i < numUsers; i++){
              named = obj.users[i].userName;
              if(userName1 == named) {
                alert("That username is taken, please enter another");
                return;
              }
            }
            newMessage=newMessage + "You changed your username";
            numChanged++;
          }
          if(firstName!=firstName1){
            if (numChanged == 0) {
              newMessage = "You changed your first name";
              numChanged++;
            }
            else {
              newMessage = newMessage + ", first name";
            }
          }
          if(lastName!= lastName1) {
            if (numChanged == 0) {
              newMessage = "You changed your last name";
              numChanged++;
            }
            else {
              newMessage=newMessage+", last name";
            }
          }
          if(password!=password1) {
            if (numChanged == 0) {
              newMessage = "You changed your password";
              numChanged++;
            }
            else {
              newMessage = newMessage +", password";
            }
          }
          var update = new User(userName1, email, firstName1, lastName1, phone, password1);
          var stringy = JSON.stringify(update);
          setCookie("currUser", stringy, 30);
          addNL(newMessage);
          window.location.replace("usersettings.html");
        }
        
      }
      
    </script>
    
  </body>
</html>