<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paidit | Bills</title>
    <link rel="stylesheet" href="/pdit_backend/app/assets/stylesheets/billaccounts.css" />
    <link rel="stylesheet" href="/pdit_backend/app/assets/stylesheets/foundation.css" />
    <link rel="stylesheet" href="/pdit_backend/app/assets/stylesheets/responsive-tables.css"/>
    <link rel="stylesheet" href="/pdit_backend/app/assets/stylesheets/test.css"/>
    
    <script type="text/javascript" src="/pdit_backend/app/assets/javascripts/bills.js"></script>
    <script type="text/javascript" src="/pdit_backend/app/assets/javascripts/responsive-tables.js"></script>
    <link rel="shortcut icon" href="img/icon/checkMark.png"/>

    <script src="js/vendor/modernizr.js"></script>
  </head>
  <body onload="getBills()">
    
      
      <div class="icon-bar five-up">
        <a class="item" href="index.html">
          <img src="img/icon/homeIconG.png" height="20" width="20"  >
          <label class="show-for-medium-up">Home</label>
        </a>
        <a class="item" href="analysis.html">
          <img src="img/icon/chartsIconG.png" height="20" width="20">
          <label class="show-for-medium-up">Bill Analysis</label>
        </a>
        <a class="item" href="billaccounts.html" id="bills">
          <img src="img/icon/billIconG.png" height="20" width="20">
          <label class="show-for-medium-up"><b>Bills</b></label>
        </a>
        <a class="item" href="notificationslog.html">
          <img src="img/icon/smsIconG.png" height="20" width="20">
          <label class="show-for-medium-up">Notification Log</label>
        </a>
        <a class="item" href="usersettings.html">
          <img src="img/icon/gearIconG.png" height="20" width="20">
          <label class="show-for-medium-up">Settings</label>
        </a>
      </div>
   

    <div class="container navigation">

      
      <div class="small-12 small-centered large-12 large-centered columns">
        <div class="large-1 columns" align = "center">
          <a href="#" class='button radius' id='addBill' >Add Bill</a>
        </div>
          <!-- BILL LIST -->
        <table class="small-11 large-11 columns" id="billTable" name = "billTable">
          <thead  id="billTableHeader">
            <tr>
              <th width="15%">Bill</th>
              <th width="10%">Due On</th>
              <th width="10%">Amount</th>
              <th width="17%">URL</th>
              <th width="13%">Notifications</th>
              <th width="15%">Repeat</th>
              <th width = "20%">Edit</th>
            </tr>
          </thead>
          <tbody >
            <tr>
              <td>Example Bill</td>
              <td>05/19/2099</td>
              <td>$500.00</td>
              <!--<td ><img src="img/icon/emailIcon40px.png"/>
              <img src="img/icon/smsIcon40px.png"/>
              </td> -->
              
              <td>www.wisconsin.edu/paidit</td>
              
              <td>Email SMS</td>
              <td>Monthly</td>
            
              <td><button>Edit</button><button>Delete</button></td>
              <!-- <td class="editBox"><img src="img/icon/editIcon40px.png" /></td> -->
              
          </tbody>
        </table>
        
        <a href="#" class="button radius" id="saveEdit">Save</a>
        <a href="#" class="button radius" id="cancelEdit">Cancel</a>        
          
        <a href="#" class="button radius" id="saveBtn">Save</a>
        <a href="#" class="button radius" id="cancelBtn">Cancel</a>
      </div> 
    </div>

    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    
    <script>
      $(document).foundation();
      
      function setCookie(cname,cvalue,exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname+"="+cvalue+"; "+expires;
      }
 
      var i;
      var allBills;
      var numBills;
      var obj;
      
      // GET BILLS - Runs on pageload gets all bills stored in cookies ======
      function getBills() {
        if (getCookie("allBills") == null || getCookie("allBills") =="" || getCookie("allBills") == '{"bills":[]}'){
          setCookie("allBills",'{"bills":[]}',30);
          allBills = '{"bills":[]}';
          numBills = 0;
        }
        else {
          obj = JSON.parse(getCookie("allBills"));
          numBills = obj.bills.length;
          for  (i=0; i < numBills; i++){
            putBill(i);
          }
        }
      }
      
      function putBill(index) {
        var table = document.getElementById("billTable");
        var row = table.insertRow(index+2);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        var cell5 = row.insertCell(4);
        var cell6 = row.insertCell(5);
        var cell7 = row.insertCell(6);
        cell1.innerHTML = obj.bills[index].name;
        cell2.innerHTML = obj.bills[index].dueDate;
        cell3.innerHTML = obj.bills[index].amount;
        cell4.innerHTML = obj.bills[index].url;
        cell5.innerHTML = obj.bills[index].notifs;
        cell6.innerHTML = obj.bills[index].repeat;
        cell7.innerHTML = '<button onClick="editRow(this)" id="edit"+index>Edit</button><button onClick="deleteRow(this)">Delete</button>';
      }
      
      function editRow(o) {
        var p=o.parentNode.parentNode;
        p.parentNode.removeChild(p);
        putInEditField();
      }
      
      var newJson;
      
      function putInEditField() {
        var j;
        var table = document.getElementById("billTable");
        var name = null;
        var date = null;
        var amount = null;
        var url = null;
        var notifs = null;
        var repeat = null;
        newJson = null;
        var find;
        for(j = 2; j < numBills+1; j++){
          var named = obj.bills[j-2].name;
          var row = table.rows.item(j).cells[0].firstChild.data;
          if (named != row) {
            name = obj.bills[j-2].name;
            date = obj.bills[j-2].date;
            amount = obj.bills[j-2].amount;
            url = obj.bills[j-2].url;
            notifs = obj.bills[j-2].notifs;
            repeat = obj.bills[j-2].repeat;
            allBills = getCookie("allBills");
            find = '{"name":"' +name;
            var tempCookie = allBills.substring(0, allBills.indexOf(find));
            var find2 = '{"name":"' +row;
            newJson = allBills.substring(allBills.indexOf(find2), allBills.length);
            newJson = tempCookie + newJson;
            break;
          }
        }
        if(newJson == null) { //editing last  & there is more than 1 bill
          name = obj.bills[(numBills-1)].name;
          date = obj.bills[(numBills-1)].date;
          amount = obj.bills[(numBills-1)].amount;
          url = obj.bills[(numBills-1)].url;
          notifs = obj.bills[(numBills-1)].notifs;
          repeat = obj.bills[(numBills-1)].repeat;
          //alert("removed last bill! Named " +  name);
          allBills = getCookie("allBills");
          //alert(allBills);
          find = ',{"name":"' +name;
          newJson = allBills.substring(0, allBills.indexOf(find))+"]}";
        }
        $('#addBill').css('visibility','hidden');
        testGet2();
        $('#billTable').find('tbody').append($('<tr id="createBill">')
        .append($('<td><input type="text" placeholder="bill name" id="billname" value = \''+name+'\' required /></td>'))
        .append($('<td><input type="text" placeholder="XX-XX-XXXX" id="dueDate" value = \''+date+'\' /></td>'))
        .append($('<td><input type="text" placeholder="amount" id="amount"  value = \''+amount+'\'/></td>'))
        .append($('<td><input type="text" placeholder="url" id="url"  value = \''+url+'\'/></td>'))
        .append($('<td><input id="emailCheckbox" type="checkbox"><label for="emailCheckbox">Email</label><input id="smsCheckbox" type="checkbox"><label for="smsCheckbox">SMS</label></td>'))
        .append($('<td><input type="radio" id="never" name="rep"><label for="never">Never</label><input type="radio" id="weekly" name="rep"><label for="weekly">Weekly</label><input type="radio" id="monthly" name="rep"><label for="monthly">Monthly</label></td>'))
        );
        if(notifs.length == 2){
          document.getElementById("emailCheckbox").checked = true;
          document.getElementById("smsCheckbox").checked = true;
        }
        else if(notifs.length == 1){
          if(notifs[0]=="Email") document.getElementById("emailCheckbox").checked = true;
          else if(notifs[0] == "SMS(text)") document.getElementById("smsCheckbox").checked = true;
        }
        
        if(repeat == "Never") document.getElementById("never").checked = true;
        else if(repeat == "Weekly") document.getElementById("weekly").checked = true;
        else document.getElementById("monthly").checked = true;
        $('#saveEdit').css('visibility','visible');
        $('#cancelEdit').css('visibility','visible');
        var myTable = document.getElementById("billTable");
        for(i = 2; i < numBills+2; i++){
          myTable.rows[i].cells[6].innerHTML = '<button>Edit</button><button onClick="deleteRow(this)">Delete</button>';
        }
      }
      
      function deleteRow(o){
        if (confirm("Are you sure?  Deleting this bill cannot be undone!") == true){
        var p=o.parentNode.parentNode;
        p.parentNode.removeChild(p);
        updateJson();
        }
      }
      
      function updateJson(){
        var j;
        var table = document.getElementById("billTable");
        for(j = 2; j < numBills+1; j++){
          var name = obj.bills[j-2].name;
          var row = table.rows.item(j).cells[0].firstChild.data;
          if (name != row) {
            var find = '{"name":"' +name;
            allBills = getCookie("allBills");
            var tempCookie = allBills.substring(0, allBills.indexOf(find));
            //alert(tempCookie);
            var find2 = '{"name":"' +row;
            var tempCookie2 = allBills.substring(allBills.indexOf(find2), allBills.length);
            tempCookie2 = tempCookie + tempCookie2;
            //alert(tempCookie2);
            //alert("removed the " + j + "th bill! named " + name +" row is " + row);
            setCookie("allBills", tempCookie2, 30);
            return;
          }
        }
        name = obj.bills[(numBills-1)].name;
        //alert("removed last bill! Named " +  name);
        allBills = getCookie("allBills");
        //alert(allBills);
        var find = ',{"name":"' +name;
        var tempCookie = allBills.substring(0, allBills.indexOf(find))+"]}";
        //alert(tempCookie);
        setCookie("allBills", tempCookie, 30);
      }
      
      function testGet(){
        $.getJSON('https://pdit-backend-jcskillings.c9.io/users/22.json', function( data ){
          var items = [];
          alert(JSON.parse(data));
          $.each( data, function( key, val ) {
          items.push( "<li id='" + key + "'>" + val + "</li>" );
          });
 
          $( "<ul/>", {
            "class": "my-new-list",
            html: items.join( "" )
          }).appendTo( "body" );
          });
      }
      
      function testGet2(){
        $.getJSON('https://pdit-backend-jcskillings.c9.io/users/22', null, function(data){
          alert('did this work???');
          alert(JSON.parse(data));
        });
        
      }
        
      
      // appends individual bill to billTable
      function loadBill(bill){
        
      }
      
      // Gets a cookie by name
      function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) {
              return c.substring(name.length, c.length);
            }
          }
        return "";
      }
      
      // Bill object constructor
      function Bill(name, dueDate, amount, url, notifs, repeat ){
        this.name = name;
        this.dueDate = dueDate;
        this.amount = amount;
        this.notifs = notifs;
        this.url = url;
        this.repeat= repeat;
      } 
      
      
      $('#addBill').click(function(){
        $('#addBill').css('visibility','hidden');
        testGet2();
        $('#billTable').find('tbody').append($('<tr id="createBill">')
        .append($('<td><input type="text" placeholder="bill name" id="billname" required /></td>'))
        .append($('<td><input type="text" placeholder="XX-XX-XXXX" id="dueDate" /></td>'))
        .append($('<td><input type="text" placeholder="amount" id="amount"  /></td>'))
        .append($('<td><input type="text" placeholder="url" id="url"  /></td>'))
        .append($('<td><input id="emailCheckbox" type="checkbox"><label for="emailCheckbox">Email</label><input id="smsCheckbox" type="checkbox"><label for="smsCheckbox">SMS</label></td>'))
        .append($('<td><input type="radio" id="never" name="rep" checked><label for="never">Never</label><input type="radio" id="weekly" name="rep"><label for="weekly">Weekly</label><input type="radio" id="monthly" name="rep"><label for="monthly">Monthly</label></td>'))
        );
        $('#saveBtn').css('visibility','visible');
        $('#cancelBtn').css('visibility','visible');
        //alert("added bill");
      });
      
      
      $('table').on('click', '.delete', function(){
        $(this).closest('tr').remove();
      });
      
      $('#cancelBtn').click( function() {
          $('#createBill').remove();
          $('#saveBtn').css('visibility','hidden');
          $('#cancelBtn').css('visibility','hidden');
          $('#addBill').css('visibility','visible');
      });
      
      $('#cancelEdit').click( function() {
          $('#createBill').remove();
          $('#saveEdit').css('visibility','hidden');
          $('#cancelEdit').css('visibility','hidden');
          $('#addBill').css('visibility','visible');
          window.location.reload();
      });
      
      $('#saveEdit').click( function() {
        //alert("save bill");
        $('#saveEdit').click(null);
        var notifs = [];
        var name = document.getElementById("billname").value;
        var dueDate =  document.getElementById("dueDate").value;
        var amount = document.getElementById("amount").value;
        var url = document.getElementById("url").value;
        var email = document.getElementById("emailCheckbox").checked;
        var sms = document.getElementById("smsCheckbox").checked;
        var repeat;
        if(document.getElementById("never").checked == true) repeat = "Never";
        else if(document.getElementById("weekly").checked == true) repeat = "Weekly";
        else if(document.getElementById("monthly").checked == true) repeat = "Monthly";
        if (email == true) {
          notifs[0] = ("Email");
          if (sms == true) notifs[1] = "SMS(text)";
        }
        if (email == false){
          if (sms == true) notifs[0] = "SMS(text)";
          else notifs[0] = "None";
        }
        
        var newBill = new Bill(name, dueDate, amount, url, notifs, repeat);
        //alert(newBill.name + " " + newBill.dueDate);
        var stringy = JSON.stringify(newBill);
        allBills = newJson;
        var tempBills = allBills.substring(0, allBills.length - 2);

        allBills = tempBills + "," + stringy + "]}";

        setCookie("allBills",allBills,30);
        $('#addBill').css('visibility','visible');
        window.location.reload();
      });
      
      $('#saveBtn').click( function() {
        alert("save bill");
        $('#saveBtn').click(null);
        var notifs = [];
        var name = document.getElementById("billname").value;
        //alert(name);
        var dueDate =  document.getElementById("dueDate").value;
        //alert(dueDate);
        var amount = document.getElementById("amount").value;
        var url = document.getElementById("url").value;
        var email = document.getElementById("emailCheckbox").checked;
        //alert(email);
        var sms = document.getElementById("smsCheckbox").checked;
        var repeat;
        if(document.getElementById("never").checked == true) repeat = "Never";
        else if(document.getElementById("weekly").checked == true) repeat = "Weekly";
        else if(document.getElementById("monthly").checked == true) repeat = "Monthly";
        if (email == true) {
          notifs[0] = ("Email");
          if (sms == true) notifs[1] = ("SMS(text)");
        }
        if (email == false){
          if (sms == true) notifs[0] = ("SMS(text)");
        }
        //alert(notifs[0]);
        
        var newBill = new Bill(name, dueDate, amount, url, notifs, repeat);
        //alert(newBill.name + " " + newBill.dueDate);
        var stringy = JSON.stringify(newBill);
        allBills = (getCookie("allBills"));
        var tempBills = allBills.substring(0, allBills.length - 2);
        if (numBills == 0) {
          allBills = tempBills + stringy + "]}";
        }
        else{
          allBills = tempBills + "," + stringy + "]}";
        }
        setCookie("allBills",allBills,30);
        $('#addBill').css('visibility','visible');
        window.location.reload();
      });
      
      function setCookie(cname,cvalue,exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname+"="+cvalue+"; "+expires;
      }
      
    </script>
  </body>
</html>